<!DOCTYPE html>
<html>
<head>

<style type="text/css">

* {
	padding: 0;
	margin: 0;
	box-sizing: border-box;
}

body {
	font-size: 14px;
	font-family: Verdana;
	color: #ddd;
	background-color: #333;
}

tile {
	display: block;
	border: 1px solid #888;
	box-shadow: 0 0 20px rgba(0, 0, 0, 0.8);
	width: 200px;
	height: 200px;
	background-size: cover;
}

tile.selected {
  border: 1px solid #fa2;
  box-shadow: 0 0 20px #fa2;
}

grid-cell {
	float: left;
	padding: 12px;
}

grid {
	display: block;
	padding: 10px;
	width: 100%;
}

player-container {
  display: block;
  position: absolute;
  top: -999px;
}

</style>

<script type="text/javascript">

const GROUPINGS =
[ {
    name: 'Nightwish',
    imageUrl: 'https://upload.wikimedia.org/wikipedia/en/2/22/OnceNightwishCover.jpg',
    tracks: 
    [ { youtubeId: 'U7kUHZ0ZS-s', name: 'Dark Chest Of Wonders' }
    , { youtubeId: '-xPIdta_uXI', name: 'Wish I Had An Angel' }
    , { youtubeId: 'kIBdpFJyFkc', name: 'Nemo' }
    , { youtubeId: 't24E8B5Ik4c', name: 'Planet Hell' }
    , { youtubeId: 'cQqZxQhDd5k', name: 'Creek Mary\'s Blood' }
    , { youtubeId: '2f6UTm3ijlU', name: 'The Siren' }
    , { youtubeId: 'A3tA0mjP2cE', name: 'Dead Gardens' }
    , { youtubeId: 'NLWARohVreE', name: 'Romanticide' }
    , { youtubeId: '9bLnMSzFeyA', name: 'Ghost Love Score' }
    , { youtubeId: '5ATooYI9LRk', name: 'Kuolema Tekee Taiteilijan' }
    , { youtubeId: 'EZOk87UwlkU', name: 'Higher Than Hope' }
    , { youtubeId: '6jqdT5jibCM', name: 'White Night Fantasy' }
    , { youtubeId: 'YF92oneQUz4', name: 'Live To Tell The Tale' }
    , { youtubeId: 'iUaa0s44w5g', name: 'She Is My Sin' }
    , { youtubeId: 'kGocsn-Zzmg', name: 'The Kinslayer' }
    , { youtubeId: 'TJQKBrdDV_4', name: 'Come Over Me' }
    , { youtubeId: 'l2UD5VdaNU8', name: 'Wanderlust' }
    , { youtubeId: 'dHJlemQjlUM', name: 'Two For Tragedy' }
    , { youtubeId: '2gmGKv5QB9w', name: 'Wishmaster' }
    , { youtubeId: '2tSgAduee8o', name: 'Bare Grace Misery' }
    , { youtubeId: 'cvfiyT8XNrE', name: 'Crownless' }
    , { youtubeId: 'jn1HCdaWRAo', name: 'Deep Silent Complete' }
    , { youtubeId: '85pt09RUl6E', name: 'Dead Boy\'s Poem' }
    , { youtubeId: 'xFTSbZ3SeJE', name: 'FantasMic' }
    , { youtubeId: 'L9rGeglGm84', name: 'Sleepwalker' }
    ]
  }
, {
    name: 'Jethro Tull',
    imageUrl: 'https://upload.wikimedia.org/wikipedia/en/d/d8/JethroTull-albums-standup.jpg',
    tracks:
    [ { youtubeId: 'R9JF7lUMH1U', name: 'A New Day Yesterday' }
    , { youtubeId: 'wlNwOJkP5P8', name: 'Jeffery Goes to Leicester Square' }
    , { youtubeId: 'z6ZJGaT30wk', name: 'Bouree' }
    , { youtubeId: 'a3uqdoJxJ50', name: 'Back to The Family' }
    , { youtubeId: 'A6VXRSVZHIY', name: 'Look Into The Sun' }
    , { youtubeId: 'Nu_xOl-I7Lc', name: 'Nothing Is Easy' }
    , { youtubeId: 'iznQpk9GLaA', name: 'Fat Man' }
    , { youtubeId: 'oGvux7w1Ea4', name: 'We Used To Know' }
    , { youtubeId: 'exXKfGPgW00', name: 'Reason For Waiting' }
    , { youtubeId: 'r-ZDY-NtpII', name: 'For A Thousand Mothers' }
    , { youtubeId: 'Tn9IyFLDtjk', name: 'Living In The Past' }
    , { youtubeId: '7u8Me9lgosc', name: 'Driving Song' }
    , { youtubeId: 'xxc_HwmcTUI', name: 'Sweet Dream' }
    , { youtubeId: 'Mxr9R2GvMbk', name: '17' }
    , { youtubeId: 'gfKzPV-Ely4', name: 'With You There To Help Me' }
    , { youtubeId: 'b1Pzk_UYnos', name: 'Nothing To Say' }
    , { youtubeId: '2gfeRCSNBQM', name: 'Alive And Well And Living In' }
    , { youtubeId: 'KQpsbE6pH8s', name: 'Son' }
    , { youtubeId: 'eG5zRt-sNWE', name: 'For Michael Collins, Jeffrey, And Me' }
    , { youtubeId: 'S5vto70Q23E', name: 'To Cry You A Song' }
    , { youtubeId: 'c5OjM3G6vnQ', name: 'A Time For Everything' }
    , { youtubeId: 'j1VYRZF8bCs', name: 'Inside' }
    , { youtubeId: 'Wdv8PmIDLCQ', name: 'Play In Time' }
    , { youtubeId: 'mp5dXgf9MwA', name: 'Sossity, You\'re A Woman' }
    , { youtubeId: 'g6iyWNTnVRI', name: 'Singing All Day' }
    , { youtubeId: '304WfksyWg0', name: 'Witch\'s Promise' }
    , { youtubeId: 'qizGFSKWAvA', name: 'Just Trying To Be' }
    , { youtubeId: 'xkzeeEU27Mw', name: 'Teacher' }
    ]
  }
, {
    name: 'Heroes IV',
    imageUrl: 'https://upload.wikimedia.org/wikipedia/en/c/cc/Heroes_of_Might_and_Magic_IV_box.jpg',
    tracks: 
    [ { youtubeId: 'cvyS50v2Uts', name: 'Main Theme' }
    , { youtubeId: 'dDHk6gXK_9s', name: 'Preserve' }
    , { youtubeId: '_OCxQHsSijw', name: 'The Last Battle' }
    , { youtubeId: 'wG9nDmv1UJg', name: 'Asylum' }
    , { youtubeId: 'J7bEWgt2EKo', name: 'The Academy of Honor' }
    , { youtubeId: 'PrZvWzbj3ek', name: 'Necropolis' }
    , { youtubeId: 'skGuDAhrkJ4', name: 'Castle Stronghold' }
    , { youtubeId: '5mZvb5bJkf0', name: 'The Haven' }
    , { youtubeId: 'CZtEEYCvJ_w', name: 'Valhalla' }
    , { youtubeId: 'hamnGzd9cYo', name: 'The Prayer' }
    , { youtubeId: 'TX96pCm3Rnc', name: 'A Wise Tale' }
    , { youtubeId: 'tNUX6Zd89C8', name: 'Wandering' }
    , { youtubeId: '79nmqEz8OCA', name: 'Hope' }
    , { youtubeId: 'kSZO8vD54ts', name: 'Floating Across Water' }
    , { youtubeId: 'g1XbSuEprpY', name: 'Searching For A Dream' }
    , { youtubeId: 'SWAWxNASEIk', name: 'Desolation' }
    , { youtubeId: 'qp0GYyEvhec', name: 'Subterranean' }
    , { youtubeId: 'rznHUwIuLCE', name: 'Credits Theme' }
    ]
  }
, {
    name: 'Alice Deejay',
    imageUrl: 'https://i.ytimg.com/p/PL3num2og-PkiJ9DTm_t215URlwETEkIOZ/sddefault.jpg',
    tracks: 
    [ { youtubeId: 'ldgwAAwj9zs', name: 'Back In My Life' }
    , { youtubeId: 'd6GTKrW5_50', name: 'No More Lies' }
    , { youtubeId: 'i1MvG3beRJ0', name: 'I Can See (See It In Your Eyes)' }
    , { youtubeId: 'oxIUA5thkH8', name: 'Everything Begins With An E' }
    , { youtubeId: 'gC9s37WOcYU', name: 'Got To Get Away' }
    , { youtubeId: '5D8kbNFvqr0', name: 'Alice DJ' }
    , { youtubeId: 'Lgs9QUtWc3M', name: 'Better Off Alone' }
    , { youtubeId: 'zlJHFEQFA3M', name: 'Celebrate Our Love' }
    , { youtubeId: 'YytZ5h9nOOo', name: 'The Lonely One' }
    , { youtubeId: 'DsWwGUYeL4k', name: 'Who Needs Guitars Anyway?' }
    , { youtubeId: 'g9Y6BM-agjA', name: 'Will I Ever' }
    , { youtubeId: 'TXpKQjXGB3Y', name: 'Elements Of Life' }
    , { youtubeId: 'IKWc6bKJWlE', name: 'Fairytales' }
    , { youtubeId: 'eYEduFxInB4', name: 'Waiting For Your Love' }
    ]
  }
, {
    name: 'AFI',
    imageUrl: 'https://i.ytimg.com/p/PLDJpDK05PqjI8-F6jwqAt75iyByVo0leZ/sddefault.jpg',
    tracks: 
    [ { youtubeId: '2geNugMv3Cc', name: 'Prelude 12/21' }
    , { youtubeId: '7Kz9xXyDPzM', name: 'Kill Caustic' }
    , { youtubeId: 'YU4hhNKsPog', name: 'Miss Murder' }
    , { youtubeId: 'Hmo6MFon6K8', name: 'Summer Shudder' }
    , { youtubeId: 'bn57e-MT2z0', name: 'The Interview' }
    , { youtubeId: 'rsrEXwozK-Y', name: 'Love Like Winter' }
    , { youtubeId: 'q-Zx-w8U3cw', name: 'Affliction' }
    , { youtubeId: 'SqQ08d78Hd8', name: 'The Missing Frame' }
    , { youtubeId: '_pO7OqyQp1c', name: 'Kiss And Control' }
    , { youtubeId: 'Iu6fo0ojwp0', name: 'The Killing Lights' }
    , { youtubeId: 'XCK-St51AzA', name: 'Endlessly, She Said' }
    ]
  }
]

// setup of models

let tracks = [], groupings = []

for (let grouping of GROUPINGS) {
  for (let track of grouping.tracks) {
    track.grouping = grouping
    tracks.push(track)
  }
  groupings.push(grouping)
}

function shuffle(array) {
  return array.sort(() => Math.random() > 0.5)
}

tracks = shuffle(tracks)

// mutable state

let currentTrack = 0
  , playerState = null
  , playerIsReady = false
  , player = null

// functional helpers

let both = (f, g) => (...args) => f(...args) && g(...args)

let find = predicate => array => array.find(predicate)

let firstIndex = predicate => array => {
  for (let i = 0; i < array.length; i++) {
    if (predicate(array[i])) {
      return i
    }
  }
  return null
}

let skip = number => array => array.slice(number + 1)

// YT player stuff
{
  let tag = document.createElement('script');

  tag.src = "https://www.youtube.com/iframe_api";
  let firstScriptTag = document.getElementsByTagName('script')[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
}

function onYouTubeIframeAPIReady() {
  console.log('onYouTubeIframeAPIReady')
  player = new YT.Player('player', {
    height: '200',
    width: '200',
    videoId: 'M7lc1UVf-VE',
    events: {
      'onReady': () => {
        console.log('onReady')
        playerIsReady = true
        playerState = YT.PlayerState.UNSTARTED

        window.addEventListener('keydown', function(event) {
          if (event.keyCode === 32) {
            if (playerState === YT.PlayerState.PLAYING) {
              player.pauseVideo()
            } else if (playerState === YT.PlayerState.PAUSED) {
              player.playVideo()
            }
          }
        })

        handleSomethingHappening()
      },
      'onStateChange': event => {
        console.log('onStateChange', event)
        if (playerState !== event.data) {
          playerState = event.data
          if (playerState === YT.PlayerState.ENDED) {
            handleSomethingHappening()
          }
        }
      }
    }
  })
  
  handleSomethingHappening()
}

// the actual code

let isSelected = track => track.grouping.selected

let afterCurrent = track =>
  currentTrack < track.position

let nextTrack = afterIndex => {
  let found = null;
  for (var i = afterIndex + 1; i < tracks.length; i++) {
    if (isSelected(tracks[i])) {
      found = i
      break
    }
  }

  if (found !== null) {
    return found
  }

  tracks = shuffle(tracks)

  for (var i = 0; i < tracks.length; i++) {
    if (isSelected(tracks[i])) {
      return i
    }
  }
}

function play(trackIndex) {
  if (trackIndex !== null) {
    currentTrack = trackIndex

    player.loadVideoById(tracks[trackIndex].youtubeId, 0 /*start seconds*/, 'small')
    player.playVideo()
  }
}

function nothingIsPlaying() {
  console.log('nothingIsPlaying', playerIsReady, playerState, YT.PlayerState.UNSTARTED, YT.PlayerState.ENDED)
  return playerIsReady && (playerState === YT.PlayerState.UNSTARTED || playerState === YT.PlayerState.ENDED)
}

function handleSomethingHappening() {
  console.log('something happened')
  if (nothingIsPlaying()) {
    console.log("playing next track")
    play(nextTrack(currentTrack))
  }
}

</script>

</head>
<body>

<player-container>
  <div id="player"></div>
</player-container>


<grid>
</grid>

<script>
// UI setup

let grid = document.getElementsByTagName('grid')[0]

function createTile(imageUrl) {
  let tile = document.createElement('tile')
  tile.style = "background-image:url('" + imageUrl + "')"

  let gridCell = document.createElement('grid-cell')
  gridCell.appendChild(tile)
  grid.appendChild(gridCell)

  return tile
}

for (let grouping of groupings) {
  let tile = grouping.tile = createTile(grouping.imageUrl)
  tile.addEventListener('click', function() {
    if (grouping.selected) {
      tile.classList.remove('selected')
      grouping.selected = false
    } else {
      tile.classList.add('selected')
      grouping.selected = true
    }
    handleSomethingHappening()
  })
}
</script>

</body>
</html>